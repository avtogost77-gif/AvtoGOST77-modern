#!/bin/bash
# ðŸ§¹ Ð¡ÐšÐ Ð˜ÐŸÐ¢ ÐžÐ§Ð˜Ð¡Ð¢ÐšÐ˜ Ð Ð•ÐŸÐžÐ—Ð˜Ð¢ÐžÐ Ð˜Ð¯ ÐžÐ¢ Ð¡Ð“Ð•ÐÐ•Ð Ð˜Ð ÐžÐ’ÐÐÐÐ«Ð¥ Ð¡Ð¢Ð ÐÐÐ˜Ð¦

echo "ðŸ§¹ ÐÐÐ§Ð˜ÐÐÐ•Ðœ ÐžÐ§Ð˜Ð¡Ð¢ÐšÐ£ Ð Ð•ÐŸÐžÐ—Ð˜Ð¢ÐžÐ Ð˜Ð¯..."
echo "=================================="

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
if [ ! -f "index.html" ] || [ ! -d ".git" ]; then
    echo -e "${RED}âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸Ð· ÐºÐ¾Ñ€Ð½Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ!${NC}"
    exit 1
fi

# 2. Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ
echo "ðŸ“Š ÐÐ½Ð°Ð»Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
ROUTE_FILES=$(find . -maxdepth 1 -name "*-*-*.html" -o -name "*-*-nedorogo.html" -o -name "*-*-srochno.html" | grep -v index | wc -l)
echo -e "ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²: ${YELLOW}${ROUTE_FILES}${NC}"

# 3. ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ñ‹ Ñ„Ð°Ð¹Ð»Ð¾Ð²
echo -e "\nðŸ“‹ ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ:"
find . -maxdepth 1 -name "*-*-*.html" | head -5 | sed 's/^\.\//  - /'

# 4. Ð¡Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ
echo -e "\n${YELLOW}âš ï¸  Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ Ð²ÑÐµ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ð¸Ð· Git!${NC}"
echo "Ð¤Ð°Ð¹Ð»Ñ‹ Ð¾ÑÑ‚Ð°Ð½ÑƒÑ‚ÑÑ Ð½Ð° Ð´Ð¸ÑÐºÐµ, Ð½Ð¾ Ð±ÑƒÐ´ÑƒÑ‚ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ñ‹ Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ."
read -p "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ? (y/N): " -n 1 -r
echo

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${RED}ÐžÑ‚Ð¼ÐµÐ½ÐµÐ½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼${NC}"
    exit 1
fi

# 5. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼/Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ .gitignore
echo -e "\nðŸ“ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ .gitignore..."
cat >> .gitignore << 'EOF'

# Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²
-*-*.html
!index*.html
!test*.html

# Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
*.zip
*.log
temp/
cache/
test-deploy/
EOF

echo -e "${GREEN}âœ… .gitignore Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½${NC}"

# 6. Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· Git (Ð½Ð¾ Ð½Ðµ Ñ Ð´Ð¸ÑÐºÐ°)
echo -e "\nðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· Git Ð¸Ð½Ð´ÐµÐºÑÐ°..."

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ
find . -maxdepth 1 \( -name "*-*-*.html" -o -name "*-*-nedorogo.html" -o -name "*-*-srochno.html" \) \
    -not -name "index*.html" -not -name "test*.html" | sed 's/^\.\///' > files_to_remove.txt

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· git Ð¿Ð°ÐºÐµÑ‚Ð°Ð¼Ð¸
if [ -s files_to_remove.txt ]; then
    cat files_to_remove.txt | xargs -n 100 git rm --cached --quiet 2>/dev/null || true
    REMOVED=$(wc -l < files_to_remove.txt)
    echo -e "${GREEN}âœ… Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ Ð¸Ð· Git: ${REMOVED} Ñ„Ð°Ð¹Ð»Ð¾Ð²${NC}"
else
    echo -e "${YELLOW}ÐÐµÑ‚ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ${NC}"
fi

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
rm -f files_to_remove.txt

# 7. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
echo -e "\nðŸ“ Ð Ð°Ð·Ð¼ÐµÑ€ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ:"
echo -e "Ð”Ð¾ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸: ${YELLOW}$(du -sh .git | cut -f1)${NC}"

# 8. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚
echo -e "\nðŸ’¾ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚..."
git add .gitignore
git commit -m "ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ: ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ð¸Ð· Git

- Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ ${ROUTE_FILES} ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
- ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½ .gitignore
- Ð¤Ð°Ð¹Ð»Ñ‹ Ð¾ÑÑ‚Ð°ÑŽÑ‚ÑÑ Ð½Ð° Ð´Ð¸ÑÐºÐµ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
- Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ñ‚ÐµÐ¿ÐµÑ€ÑŒ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ð¹ ÐºÐ¾Ð´"

echo -e "${GREEN}âœ… ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚ ÑÐ¾Ð·Ð´Ð°Ð½${NC}"

# 9. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸
echo -e "\nðŸ“Œ ${YELLOW}Ð Ð•ÐšÐžÐœÐ•ÐÐ”ÐÐ¦Ð˜Ð˜:${NC}"
echo "1. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ 'git push' Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹"
echo "2. Ð”Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ BFG Repo-Cleaner:"
echo "   java -jar bfg.jar --delete-files '*-*-*.html' --no-blob-protection"
echo "3. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ CI/CD Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ðµ"
echo "4. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ 'node scripts/generate-routes.js' Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†"

echo -e "\n${GREEN}ðŸŽ‰ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!${NC}"
echo "Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð»ÐµÐ³ÐºÐ¸Ð¹ Ð¸ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹!"