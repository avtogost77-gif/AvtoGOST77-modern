#!/bin/bash

# üöÄ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –î–ï–ü–õ–û–ô –ù–ê VPS
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

echo "üöÄ –ù–ê–ß–ò–ù–ê–ï–ú –î–ï–ü–õ–û–ô –ù–ê VPS..."

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
VPS_HOST="194.87.95.83"
VPS_USER="root"
VPS_PATH="/var/www/avtogost77.ru"
GITHUB_REPO="https://github.com/avtogost77-gif/AvtoGOST77-modern.git"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# 1. –ö–æ–º–º–∏—Ç–∏–º –∏ –ø—É—à–∏–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo -e "${YELLOW}üì¶ –®–∞–≥ 1: –ö–æ–º–º–∏—Ç–∏–º –∏ –ø—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è...${NC}"
git add -A
git commit -m "üöÄ AUTO-DEPLOY: –§–∏–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω manifest.json (SVG –∏–∫–æ–Ω–∫–∏)
- –î–æ–±–∞–≤–ª–µ–Ω telegram-sender.js –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º
- –ù–∞—Å—Ç—Ä–æ–µ–Ω —Ä–µ–∞–ª—å–Ω—ã–π Tawk.to ID
- –í—Å–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ +79162720932"

git push origin main

# 2. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ VPS –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
echo -e "${YELLOW}üîÑ –®–∞–≥ 2: –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –Ω–∞ VPS...${NC}"

# –°–æ–∑–¥–∞–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ VPS
VPS_COMMANDS=$(cat << 'EOF'
cd /var/www/avtogost77.ru

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
CURRENT_BRANCH=$(git branch --show-current)
echo "–¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"

# –ï—Å–ª–∏ –º—ã –≤ ultimate-version, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ main
if [ "$CURRENT_BRANCH" = "ultimate-version" ]; then
    echo "–ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ main..."
    git checkout main
fi

# –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
echo "–û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
git fetch origin
git pull origin main

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
chown -R www-data:www-data /var/www/avtogost77.ru
chmod -R 755 /var/www/avtogost77.ru

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Nginx –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Nginx..."
systemctl reload nginx

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤..."
systemctl status nginx --no-pager | head -10

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
EOF
)

# –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—ã –Ω–∞ VPS
ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST "$VPS_COMMANDS"

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∞–π—Ç–∞
echo -e "${YELLOW}üîç –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∞–π—Ç–∞...${NC}"
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º HTTP —Å—Ç–∞—Ç—É—Å
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://avtogost77.ru)

if [ "$HTTP_STATUS" = "200" ]; then
    echo -e "${GREEN}‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω! HTTP —Å—Ç–∞—Ç—É—Å: $HTTP_STATUS${NC}"
else
    echo -e "${RED}‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–∞–π—Ç–æ–º! HTTP —Å—Ç–∞—Ç—É—Å: $HTTP_STATUS${NC}"
fi

# 4. –í—ã–≤–æ–¥–∏–º –∏—Ç–æ–≥–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
echo -e "${GREEN}
================================
üéâ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù!
================================

üìå –°–∞–π—Ç: https://avtogost77.ru
üìä –ú–µ—Ç—Ä–∏–∫–∞: https://metrika.yandex.ru/dashboard?id=103413788
üí¨ Tawk.to: https://dashboard.tawk.to
üì± Telegram –±–æ—Ç: @avtogost77_bot

‚ö†Ô∏è  –ù–ï –ó–ê–ë–£–î–¨:
1. –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ —É @BotFather
2. –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ telegram-sender.js
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å father_bot.py –Ω–∞ VPS

${NC}"