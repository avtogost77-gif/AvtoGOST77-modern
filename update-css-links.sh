#!/bin/bash

# ========================================================
# üîó –û–ë–ù–û–í–õ–ï–ù–ò–ï CSS –°–°–´–õ–û–ö - –ê–í–¢–û–ì–û–°–¢ V2.0
# –ó–∞–º–µ–Ω—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ CSS —Ñ–∞–π–ª—ã –Ω–∞ –æ–¥–∏–Ω –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π
# ========================================================

echo "üîó –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ CSS —Å—Å—ã–ª–æ–∫..."

# –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
BACKUP_DIR="backup-css-links-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$BACKUP_DIR"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
backup_file() {
    local file="$1"
    local backup_path="$BACKUP_DIR/$(basename "$file")"
    cp "$file" "$backup_path"
    echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: $backup_path"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è CSS —Å—Å—ã–ª–æ–∫
update_css_links() {
    local file="$1"
    local temp_file="/tmp/$(basename "$file")"
    
    # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
    backup_file "$file"
    
    # –ó–∞–º–µ–Ω—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ CSS —Ñ–∞–π–ª—ã –Ω–∞ –æ–¥–∏–Ω –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π
    awk '
    BEGIN { 
        css_replaced = 0 
        in_head = 0
    }
    
    /<head>/ { in_head = 1 }
    /<\/head>/ { in_head = 0 }
    
    in_head && /<link[^>]*rel="stylesheet"[^>]*>/ {
        if (css_replaced == 0) {
            # –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–≤—ã–π CSS —Ñ–∞–π–ª –Ω–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π
            print "    <link rel=\"stylesheet\" href=\"assets/css/unified-optimized.min.css?v=20250814-optimized\">"
            css_replaced = 1
        } else {
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ CSS —Ñ–∞–π–ª—ã
            next
        }
    }
    
    { print }
    ' "$file" > "$temp_file"
    
    # –ó–∞–º–µ–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
    mv "$temp_file" "$file"
    echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω: $file"
}

# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ HTML —Ñ–∞–π–ª—ã
echo "üìÅ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º HTML —Ñ–∞–π–ª—ã..."

for file in *.html; do
    if [ -f "$file" ]; then
        echo "üîß –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º: $file"
        update_css_links "$file"
    fi
done

# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã –≤ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö
for subdir in blog/; do
    if [ -d "$subdir" ]; then
        echo "üìÅ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: $subdir"
        
        for file in "$subdir"/*.html; do
            if [ -f "$file" ]; then
                echo "üîß –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º: $file"
                update_css_links "$file"
            fi
        done
    fi
done

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
echo ""
echo "üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø:"
echo "========================"
echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Å–æ–∑–¥–∞–Ω—ã –≤: $BACKUP_DIR"
echo "‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ HTML —Ñ–∞–π–ª–æ–≤: $(find . -name "*.html" | wc -l)"
echo "‚úÖ –ó–∞–º–µ–Ω–µ–Ω—ã CSS —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Ñ–∞–π–ª"
echo "‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è"

echo ""
echo "üéØ –û–ë–ù–û–í–õ–ï–ù–ò–ï CSS –°–°–´–õ–û–ö –ó–ê–í–ï–†–®–ï–ù–û!"
echo "üìÅ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏: $BACKUP_DIR"
echo "üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∞!"
