name: Generate & Deploy Landing Pages

on:
  push:
    paths:
      - 'data/**'
      - 'templates/**'
      - 'scripts/generate.js'
  schedule:
    - cron: '0 23 * * *'  # ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 23:00 MSK (~20:00 UTC)

env:
  BATCH_SIZE: '400'

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Read generator state
        id: state
        run: |
          OFFSET=$(cat .generator_state.txt 2>/dev/null || echo 0)
          echo "OFFSET=$OFFSET" >> $GITHUB_ENV
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - run: npm ci --silent
      - name: Generate batch
        run: |
          node scripts/generate.js
      - name: Update generator state
        run: |
          NEW_OFFSET=$((OFFSET+BATCH_SIZE))
          echo $NEW_OFFSET > .generator_state.txt
      - name: Commit & push batch
        run: |
          git config user.name 'auto-bot'
          git config user.email 'bot@example.com'
          git add .
          git commit -m "ðŸ¤– Batch landing pages OFFSET $OFFSET" || echo "Nothing to commit"
          git push origin ${{ github.ref }}
      - name: Ping Yandex & Google
        run: |
          curl -s "https://yandex.ru/indexnow?url=https://avtogost77.ru/sitemap.xml" || true
          curl -s "https://www.bing.com/indexnow?url=https://avtogost77.ru/sitemap.xml&key=static" || true
      - name: Deploy to hosting
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
        run: bash deploy-final.sh