name: Generate & Deploy Landing Pages

on:
  workflow_dispatch:
  # Запуск только при создании тегов версий
  push:
    tags:
      - 'generate-*'  # Только при тегах типа generate-v1, generate-batch-1 и т.д.
  # Или при коммитах со специальным сообщением
  # push:
  #   branches: [main]
  #   paths:
  #     - 'scripts/generate*.js'  # Только если изменились скрипты генерации
  #     - '.github/workflows/generate-landing.yml'  # Или сам workflow
  schedule:
    - cron: '0 3 * * 0'  # Раз в неделю в воскресенье в 3:00 MSK

env:
  BATCH_SIZE: '400'  # Разумный размер батча

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Read generator state
        id: state
        run: |
          OFFSET=$(cat .generator_state.txt 2>/dev/null || echo 0)
          echo "OFFSET=$OFFSET" >> $GITHUB_ENV
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - run: npm install --silent
      - name: Generate batch
        run: |
          node scripts/generate-enhanced.js
      - name: Update generator state
        run: |
          NEW_OFFSET=$((OFFSET+BATCH_SIZE))
          echo $NEW_OFFSET > .generator_state.txt
      - name: Commit & push batch
        run: |
          git config user.name 'auto-bot'
          git config user.email 'bot@example.com'
          git add .
          git commit -m "🤖 Batch landing pages OFFSET $OFFSET" || echo "Nothing to commit"
          git push origin ${{ github.ref }}
      - name: Ping Yandex & Google
        run: |
          curl -s "https://yandex.ru/indexnow?url=https://avtogost77.ru/sitemap.xml" || true
          curl -s "https://www.bing.com/indexnow?url=https://avtogost77.ru/sitemap.xml&key=static" || true