name: Generate & Deploy Landing Pages

on:
  workflow_dispatch:
  # Ð—Ð°Ð¿ÑƒÑÐº Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ñ‚ÐµÐ³Ð¾Ð² Ð²ÐµÑ€ÑÐ¸Ð¹
  push:
    tags:
      - 'generate-*'  # Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ Ñ‚ÐµÐ³Ð°Ñ… Ñ‚Ð¸Ð¿Ð° generate-v1, generate-batch-1 Ð¸ Ñ‚.Ð´.
  # Ð˜Ð»Ð¸ Ð¿Ñ€Ð¸ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°Ñ… ÑÐ¾ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÐµÐ¼
  # push:
  #   branches: [main]
  #   paths:
  #     - 'scripts/generate*.js'  # Ð¢Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¸ÑÑŒ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸
  #     - '.github/workflows/generate-landing.yml'  # Ð˜Ð»Ð¸ ÑÐ°Ð¼ workflow
  schedule:
    - cron: '0 3 * * 0'  # Ð Ð°Ð· Ð² Ð½ÐµÐ´ÐµÐ»ÑŽ Ð² Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ Ð² 3:00 MSK

env:
  BATCH_SIZE: '400'  # Ð Ð°Ð·ÑƒÐ¼Ð½Ñ‹Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð±Ð°Ñ‚Ñ‡Ð°

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Read generator state
        id: state
        run: |
          OFFSET=$(cat .generator_state.txt 2>/dev/null || echo 0)
          echo "OFFSET=$OFFSET" >> $GITHUB_ENV
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - run: npm install --silent
      - name: Generate batch
        run: |
          node scripts/generate-enhanced.js
      - name: Update generator state
        run: |
          NEW_OFFSET=$((OFFSET+BATCH_SIZE))
          echo $NEW_OFFSET > .generator_state.txt
      - name: Commit & push batch
        run: |
          git config user.name 'auto-bot'
          git config user.email 'bot@example.com'
          git add .
          git commit -m "ðŸ¤– Batch landing pages OFFSET $OFFSET" || echo "Nothing to commit"
          git push origin ${{ github.ref }}
      - name: Ping Yandex & Google
        run: |
          curl -s "https://yandex.ru/indexnow?url=https://avtogost77.ru/sitemap.xml" || true
          curl -s "https://www.bing.com/indexnow?url=https://avtogost77.ru/sitemap.xml&key=static" || true