name: SEO Pages Auto-Generator

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      pages_count:
        description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏'
        required: false
        default: '10'
      strategy:
        description: '–°—Ç—Ä–∞—Ç–µ–≥–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏'
        required: false
        default: 'routes'
        type: choice
        options:
        - routes
        - industries
        - calculators

jobs:
  generate-seo-pages:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      run: |
        npm init -y
        npm install axios cheerio fs-extra
    
    - name: Generate Routes Pages
      if: ${{ github.event.inputs.strategy == 'routes' || github.event.schedule }}
      run: node .github/scripts/generate-routes.js
      env:
        PAGES_COUNT: ${{ github.event.inputs.pages_count || '10' }}
    
    - name: Generate Industry Pages
      if: ${{ github.event.inputs.strategy == 'industries' }}
      run: node .github/scripts/generate-industries.js
      env:
        PAGES_COUNT: ${{ github.event.inputs.pages_count || '5' }}
    
    - name: Generate Calculator Pages
      if: ${{ github.event.inputs.strategy == 'calculators' }}
      run: node .github/scripts/generate-calculators.js
      env:
        PAGES_COUNT: ${{ github.event.inputs.pages_count || '3' }}
    
    - name: Update Sitemap
      run: node .github/scripts/update-sitemap.js
    
    - name: Update Internal Links
      run: node .github/scripts/update-links.js
    
    - name: Commit and Push
      run: |
        git config --local user.email "seo-bot@avtogost77.ru"
        git config --local user.name "SEO Auto-Generator"
        git add .
        git diff --staged --quiet || git commit -m "ü§ñ –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è SEO —Å—Ç—Ä–∞–Ω–∏—Ü - $(date '+%Y-%m-%d %H:%M')"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Deploy to Server (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      if: success()
      run: |
        echo "–°—Ç—Ä–∞–Ω–∏—Ü—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –¥–µ–ø–ª–æ—é"
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä