name: Deploy to REG.RU

on:
  # push:
  #   branches: [ main ]  # –û–¢–ö–õ–Æ–ß–ï–ù–û - –∏—Å–ø–æ–ª—å–∑—É–µ–º VPS —Ç–µ–ø–µ—Ä—å!
  workflow_dispatch:  # –¢–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v3
    
    - name: üì¶ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: üì¶ Install dependencies
      run: npm ci
    
    - name: üèóÔ∏è Generate static pages
      run: |
        echo "üöÄ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤..."
        node scripts/generate-routes.js
        echo "‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü: $(find . -name "*-*-*.html" | wc -l)"
    
    - name: üßπ Clean unnecessary files
      run: |
        # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω—É–∂–Ω—ã –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥–µ
        rm -rf .git .github node_modules
        rm -f .gitignore package-lock.json
        rm -f *.md *.sh
        find . -name "*.map" -delete
    
    - name: üìä Update analytics
      run: |
        # –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if [ -f "update-analytics.js" ]; then
          node update-analytics.js
        fi
    
    - name: üöÄ Deploy via FTP
      uses: SamKirkland/FTP-Deploy-Action@4.3.3
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        port: 21
        protocol: ftp
        # REG.RU —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞
        server-dir: /www/avtogost77.ru/
        # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/*.md
          **/*.log
          **/scripts/**
          **/test/**
          **/*.sh
          **/package*.json
          **/.env*
        # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
        parallel: 10
        # –¢–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        # state-name: .ftp-deploy-sync-state.json
    
    - name: üîî Notify success
      if: success()
      run: |
        curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "text=‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ REG.RU —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!%0A%0Aüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:%0A- –ö–æ–º–º–∏—Ç: ${{ github.sha }}%0A- –ê–≤—Ç–æ—Ä: ${{ github.actor }}%0A- –í—Ä–µ–º—è: $(date '+%d.%m.%Y %H:%M')"
    
    - name: üö® Notify failure
      if: failure()
      run: |
        curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "text=‚ùå –û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è –Ω–∞ REG.RU!%0A%0Aüìä –î–µ—Ç–∞–ª–∏:%0A- –ö–æ–º–º–∏—Ç: ${{ github.sha }}%0A- –ê–≤—Ç–æ—Ä: ${{ github.actor }}%0A- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: https://github.com/${{ github.repository }}/actions"

# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —á–µ—Ä–µ–∑ lftp (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π)
# - name: üöÄ Deploy via LFTP
#   run: |
#     sudo apt-get install -y lftp
#     lftp -c "
#       set ftp:ssl-allow no
#       set ftp:passive-mode on
#       open ftp://${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}@${{ secrets.FTP_SERVER }}
#       mirror -R --parallel=5 --exclude=.git/ --exclude=node_modules/ --exclude=*.md ./ /www/avtogost77.ru/
#       bye
#     "