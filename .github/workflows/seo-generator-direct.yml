name: SEO Pages Generator (Direct Push)

on:
  workflow_dispatch:
    inputs:
      pages_count:
        description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏'
        required: false
        default: '50'
      strategy:
        description: '–°—Ç—Ä–∞—Ç–µ–≥–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏'
        required: false
        default: 'routes-extended'
        type: choice
        options:
        - routes-extended
        - calculators
        - industries

jobs:
  generate-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install fs-extra axios --no-package-lock --no-save

    - name: Generate Pages
      run: |
        PAGES_COUNT="${{ github.event.inputs.pages_count || '50' }}"
        STRATEGY="${{ github.event.inputs.strategy || 'routes-extended' }}"
        
        echo "üöÄ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º $PAGES_COUNT —Å—Ç—Ä–∞–Ω–∏—Ü ($STRATEGY)"
        
        case $STRATEGY in
          "routes-extended")
            node .github/scripts/generate-routes-extended.js
            ;;
          "calculators")
            node .github/scripts/generate-calculators.js
            ;;
          "industries")
            node .github/scripts/generate-industries.js
            ;;
        esac

    - name: Update Sitemap
      run: |
        if [ -f ".github/scripts/update-sitemap.js" ]; then
          node .github/scripts/update-sitemap.js
        fi

    - name: Check Changes
      run: |
        echo "üìä –ü–†–û–í–ï–†–Ø–ï–ú –ò–ó–ú–ï–ù–ï–ù–ò–Ø:"
        git status --porcelain
        
        if [ -n "$(git status --porcelain)" ]; then
          echo "‚úÖ –ï—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          echo "HAS_CHANGES=true" >> $GITHUB_ENV
        else
          echo "üìù –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          echo "HAS_CHANGES=false" >> $GITHUB_ENV
        fi

    - name: Commit and Push (if changes exist)
      if: env.HAS_CHANGES == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add -A
        
        PAGES_COUNT="${{ github.event.inputs.pages_count || '50' }}"
        STRATEGY="${{ github.event.inputs.strategy || 'routes-extended' }}"
        
        git commit -m "ü§ñ AUTO-SEO: $PAGES_COUNT —Å—Ç—Ä–∞–Ω–∏—Ü ($STRATEGY)

        ‚úÖ –°—Ç—Ä–∞—Ç–µ–≥–∏—è: $STRATEGY
        üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: $PAGES_COUNT —Å—Ç—Ä–∞–Ω–∏—Ü
        üó∫Ô∏è Sitemap –æ–±–Ω–æ–≤–ª–µ–Ω
        üïê $(date '+%Y-%m-%d %H:%M:%S')"
        
        # –ü—Ä–æ–±—É–µ–º push —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
        git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/avtogost77-gif/AvtoGOST77-modern.git main || \
        git push origin main

    - name: Summary
      run: |
        if [ "${{ env.HAS_CHANGES }}" = "true" ]; then
          echo "üéâ –£–°–ü–ï–®–ù–û! –°—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
        else
          echo "üìù –ù–µ—Ç –Ω–æ–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è"
        fi
        
        echo "üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê:"
        find routes/ -name "*.html" 2>/dev/null | wc -l | xargs echo "–ú–∞—Ä—à—Ä—É—Ç—ã:"
        find calculators/ -name "*.html" 2>/dev/null | wc -l | xargs echo "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã:"
        find industries/ -name "*.html" 2>/dev/null | wc -l | xargs echo "–û—Ç—Ä–∞—Å–ª–∏:"